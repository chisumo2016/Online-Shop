RESOURCES
Bonus: workbench running.
https://github.com/JustSteveKing/shop
https://juststeveking.notion.site/Episode-6-3d413656323548aebc6c02b6a95e549c
https://github.com/brendt/phpstorm-photon-them
https://github.com/timacdonald/json-api
https://laravelshift.com/phpunit-to-pest-converter
https://laravelshift.com/workbench
https://pestphp.com/
https://meetup.laravel.com/events
https://www.youtube.com/watch?v=2UyDBArGLDY

Episode 5
In this episode we are going to carry on using TDD and event sourcing to finish off our cart functionality.
 -TDD
 -Event sourcing
 Steps
 -Switched to branch 'feature/cart
     git checkout feature/cart
 -Run test
   - ./vendor/bin/pest
 -Composer update
    -composer update
-Update the cart (TDD)
    -Write a test 1s from CartTest to update the cart
    -Uncomment the web route api
    -Create the UpdateController
       php artisan make:controller Api\\V1\\Carts\\Products\\UpdateController --invokable
  -Add logic into UpdateController
  -Add the validation
    php artisan make:request  Api\\V1\\Carts\\Products\\UpdateRequest
 -we cn decrease the cart item(write a test)
 -In summary we can add ,increase ,decrease and remove the cart

 TIME TO REFACTOR OUR CODE
   Pseudocode in updateController
        -Create cart aggregate
        -if quantity is 0 trigger the remove product event
         -otherwise trigger the change quantity event


code removed after introducing the aggregate UpdateController

            //if quantity equal 0 remove cart item
        if ($request->get('quantity') === 0) {
             //remove item
            $item->delete();
        }else{
            //update cart item quantity
            $item->update([
                //'quantity' => ($item->quantity + $request->get('quantity')),
                 'quantity' => $request->get('quantity'),
               ]);
        }

-The test will fail
   Failed asserting that a row in the table [cart_items] does not match the attributes {
       "id": 2
   }.

-we need to move our logic into action ,our controller must be cleaned
-we're going to put into Actions folder
   * src/Domains/Customer/Actions/ChangeCartQuantity.php
-Add another Action RemoveProductFromCart
    src/Domains/Customer/Actions/RemoveProductFromCart.php

    STEPS
1-write a test to delete the cart `can remove an item from the cart`
2-Create a DeleteController
    php artisan make:controller Api\\V1\\Carts\\Products\\DeleteController --invokable
3-Uncomment the API route for delete in api route:
       Route::delete('{cart:uuid}/products/{Item:uuid}', App\Http\Controllers\Api\V1\Carts\products\DeleteController::class)->name('products:delete')
4-Run the test
  * ./vendor/bin/pest
    Expected response status code [202] but received 200.
    Failed asserting that 202 is identical to 200.
    To remove this error , you need to write a functionality on DeleteController to remove the error
5-Open DeleteController and functionality
6- Run the test again
     ./vendor/bin/pest
7-Another error appeared again
    Expected response status code [202] but received 500.
   The following exception occurred during the request:
   TypeError: App\Http\Controllers\Api\V1\Carts\Products\DeleteController::__invoke(): Return value must be of type Illuminate\Http\Response
8:Solution
    Remove the :Response
9:Run again the test
    ./vendor/bin/pest
10.Another error appeared
     Expected response status code [202] but received 200.
     Failed asserting that 202 is identical to 200.
11:Write the functionality inside the controller  delete
     $item->delete();
         return new Response(
             content: null,
             status: Http::ACCEPTED
         );
12:9:Run again the test
       ./vendor/bin/pest
13:Passed the Test

14 :Go back to the test and add the assertDelete()
      assertDeleted($item);
15:Run again the test
       ./vendor/bin/pest
16:Passed the Test

17:Refactor to use the event sourcing , add the ElquentEvent in the test
    expect(EloquentStoredEvent::query()->get())->toHaveCount(count: 0);

    //assertDeleted($item);
        expect(EloquentStoredEvent::query()->get())->toHaveCount(count: 1);
        expect(EloquentStoredEvent::query()->first()->event_class)->toEqual(ProductWasRemovedFromCart::class);

18:Run again the test
       ./vendor/bin/pest
19:Fail the Test after adding the  EloquentStoredEvent
     • Tests\Feature\CartTest > it can remove an item from the cart
      Failed asserting that actual size 0 matches expected size 1.
20:Solution
  We need to call the Actions RemoveProductionFromCart inside the DeleteController and remove delete()
       RemoveProductFromCart::handle(
                 cart: $cart,
                 item:$item
             );
             -calling the aggregate , removing  the product
21:Run again the test
       ./vendor/bin/pest

22:Passed the test

NEW FEATURE - COUPON TO OUR CART

1 -Add a coupon to our cart - API route:
    Route::post('{cart:uuid}/coupons', App\Http\Controllers\Api\V1\Carts\coupons\StoreController::class)->name('coupons:store');
2:Create a Controller
   php artisan make:controller Api\\V1\\Carts\\Coupons\\StoreController --invokable
3:Write a test in cartTest
    `can apply a coupon to the cart`
4: run route
     php artisan route:list --columns=uri,name,method
5:write the logic in the test
6:Run the Test
   ./vendor/bin/pest
7: Failed the Test
     • Tests\Feature\CartTest > it can apply a coupon to the cart
       Illuminate\Routing\Exceptions\UrlGenerationException

      Missing required parameter for [Route: api:v1:carts:coupons:store] [URI: api/v1/carts/{cart}/coupons] [Missing parameter: cart].
8: Problem ,missing the parameter
9:Pass the parameter into StoreController
10:Run the Test
      ./vendor/bin/pest
11: Failed the Test
    • Tests\Feature\CartTest > it can apply a coupon to the cart
      Illuminate\Routing\Exceptions\UrlGenerationException

     Missing required parameter for [Route: api:v1:carts:coupons:store] [URI: api/v1/carts/{cart}/coupons] [Missing parameter: cart].
12: Solution ,add parameter inside the route('' ,[]) - test itsself
     uri: route('api:v1:carts:coupons:store',$cart->uuid),
13:Run the Test
        ./vendor/bin/pest
14: Failed the Test
    • Tests\Feature\CartTest > it can apply a coupon to the cart
      Expected response status code [202] but received 405.
      Failed asserting that 202 is identical to 405.

15 :Let change our CartFactory
    //$useCoupon ? $this->faker->imei() : null,
    'coupon'        =>  null,
    //$useCoupon ? $this->faker->numberBetween(250, 2500) : 0,
    'reduction'     =>  0,
16:Pass expect() in the test
17:Run the Test
    ./vendor/bin/pest
18: Failed the Test
      • Tests\Feature\CartTest > it can apply a coupon to the cart
      Expected response status code [202] but received 405.
      Failed asserting that 202 is identical to 405.
19: Solution is to create coupon request
    php artisan make:request  Api\\V1\\Carts\\Coupons\\StoreRequest
20:Write the validation rule inside store request
21:Run the Test
       ./vendor/bin/pest
22: Failed the Test
          • Tests\Feature\CartTest > it can apply a coupon to the cart
          Expected response status code [202] but received 405.
          Failed asserting that 202 is identical to 405.
23:Write logic into store controller

24:Run the Test
       ./vendor/bin/pest
25:Passed the Test
26:Implement the EventSource in the CartTest

    expect(EloquentStoredEvent::query()->get())->toHaveCount(count: 0);

      replace
      expect(
              Cart::query()->find($cart->id)
          )->reduction->toEqual($coupon->reduction)->coupon->toEqual($coupon->code);

      To
    expect(EloquentStoredEvent::query()->get())->toHaveCount(count: 1);
    expect(EloquentStoredEvent::query()->first()->event_class)->toEqual(ProductWasRemovedFromCart::class);

27:Run the Test
          ./vendor/bin/pest
28: Test fail after adding the EloquentEvent Source
     • Tests\Feature\CartTest > it can apply a coupon to the cart
      Failed asserting that actual size 0 matches expected size 1.
29: Solution is to write another function inside the CartAggregate
      -name of function ApplyCoupon
      -Create an events  called CouponWasApplied and extends to spatie library shouldBeStored
      -Inside the src/Domains/Customer/Events/CouponWasApplied.php
         -write a constructor
30:Back to ApplyCoupon aggregate  and import the  CouponWasApplied
31:To write new function inside the  Projector
    -call onCouponWasApplied
    -write the logic
32:Run the Test
      ./vendor/bin/pest
33:Test fail
  • Tests\Feature\CartTest > it can apply a coupon to the cart
   Failed asserting that actual size 0 matches expected size 1.
34:Solution
    instead of update , we're going to use CartAggregate
       $cart->update([
          'coupon'       => $coupon->code,
           'reduction'   => $coupon->reduction
       ]);

34::Run the Test
      ./vendor/bin/pest
35:Test fail
     • Tests\Feature\CartTest > it can apply a coupon to the cart
     Failed asserting that two strings are equal.

36:Problem was in the test
     CouponWasApplied in the eloquentEvent Source
       expect(EloquentStoredEvent::query()->first()->event_class)->toEqual(CouponWasApplied::class);
37:Run the Test
      ./vendor/bin/pest
38:Passed the Test








switch ($quantity){ //$quantity = $request->get('quantity')
            case 0;
                $aggregate->removeProduct(
                    purchasableID: $item->id,
                    cartID:        $cart->id,
                    type:          get_class($item)
                )->persist();

                break;

            case ($quantity > $item->quantity);
                $aggregate->increaseQuantity(
                    cartID:     $cart->id,
                    cartItemID: $item->id,
                    quantity:   $quantity,
                )->persist();

                break;

            case ($quantity < $item->quantity );
                $aggregate->decreaseQuantity(
                    cartID:     $cart->id,
                    cartItemID: $item->id,
                    quantity:   $quantity,
                )->persist();

                break;
        }
